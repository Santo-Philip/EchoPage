---
import Layout from "@/layouts/Layout.astro";
import { supabase } from "@/lib/supabase";


const { data, error } = await supabase.auth.getUser();
if (error || !data.user?.id) {
  return Astro.redirect("/");
}

const user = {
  name: data.user?.user_metadata.full_name,
  email: data.user?.email,
  id: data.user?.id,
};


const PAGE_SIZE = 6;
const page = Number(Astro.url.searchParams.get("page") || 1);
const from = (page - 1) * PAGE_SIZE;
const to = from + PAGE_SIZE - 1;

const { data: blogData, error: blogError, count } = await supabase
  .from("draft")
  .select("*", { count: "exact" })
  .eq("author", user.id)
  .order("created_at", { ascending: false })
  .range(from, to);

const totalPages = count ? Math.ceil(count / PAGE_SIZE) : 1;

const emails: string[] = import.meta.env.EMAIL.split(",");
---

<Layout title="Dashboard" desc="Welcome to your dashboard">
  <section class="max-w-screen-lg mx-auto px-2 py-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Welcome back, {user.name} üëã</h1>
        <p class="text-gray-600">Manage your posts and account settings here.</p>
      </div>
      <form action="api/auth/signout" method="get">
        <button class="bg-red-500 flex gap-3 hover:bg-red-600 text-white font-medium px-5 py-2 rounded-xl shadow">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out-icon lucide-log-out"><path d="m16 17 5-5-5-5"/><path d="M21 12H9"/><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/></svg>
          Logout
        </button>
      </form>
    </div>

{ emails.includes(user.email || '') && (
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mt-8">
    <a href="/a/messages" class="bg-bg-secondary p-5 rounded-xl outline outline-accent-hover  shadow-md hover:shadow-xl transition text-center">
      <p class=" text-xl font-semibold text-text-primary">Messages</p>
      <p class="text-sm text-text-secondary mt-1">View messages </p>
    </a>
    <a href="/a/review" class="bg-bg-secondary p-5 rounded-xl outline outline-accent-hover  shadow-md hover:shadow-xl transition text-center">
      <p class=" text-xl font-semibold text-text-primary">Post Management</p>
      <p class="text-sm text-text-secondary mt-1">Review and manage posts</p>
    </a>
    <a href="/a/category" class="bg-bg-secondary p-5 rounded-xl outline outline-accent-hover  shadow-md hover:shadow-xl transition text-center">
      <p class=" text-xl font-semibold text-text-primary">Category Management</p>
      <p class="text-sm text-text-secondary mt-1">View and manage categories</p>
    </a>
    <a href="/" class="bg-bg-secondary p-5 rounded-xl outline outline-accent-hover  shadow-md hover:shadow-xl transition text-center">
      <p class=" text-xl font-semibold text-text-primary">Platform Analytics</p>
      <p class="text-sm text-text-secondary mt-1">View Platform data and analytics</p>
    </a>

  </div>
  )}
    <div class="mt-12 text-center">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Quick Actions</h2>
      <a
        href="/draft/editor"
        class="bg-blue-500 hover:bg-blue-600 text-white font-medium px-8 py-4 rounded-2xl text-lg shadow transition"
      >
        ‚úçÔ∏è Write New Post
      </a>
    </div>
    <div class="mt-16">
      <div class="flex gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rss-icon lucide-rss"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>
      <h2 class="text-xl font-bold text-gray-900 mb-4">Your Published Posts</h2>
</div>
      {blogData && blogData.length > 0 ? (
        <div class="gap-2 grid-cols-1 grid  md:grid-cols-2">
          {blogData.map((blog) => (
            <div class="bg-bg-secondary rounded-xl shadow hover:shadow-md transition">
              {
                blog.thumb ? (   
              <img src={blog.thumb} alt="thumbnail" class="aspect-video rounded-2xl object-cover"/>
                ) : (
                  <div></div>
                )
              }
              <h3 class="text-lg p-2 font-semibold text-text-primary">{blog.title || "Untitled Draft"}</h3>
              <p class="p-2 text-sm text-text-secondary mt-1">{blog.desc || "No description"}</p>
              <div class="flex p-4 justify-between items-center mt-3">
                <span class="text-xs text-gray-400">
                  {new Date(blog.created_at).toLocaleDateString()}
                </span>
                <a
                  href={`/draft/manage?id=${blog.id}`}
                  class="text-blue-500 hover:underline text-sm"
                >
                  Manage ‚Üí
                </a>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <p class="text-gray-500">You don‚Äôt have any Post published.</p>
      )}

      <!-- Pagination -->
      {totalPages > 1 && (
        <div class="flex justify-center gap-3 mt-8">
          {Array.from({ length: totalPages }).map((_, i) => {
            const pageNum = i + 1;
            return (
              <a
                href={`?page=${pageNum}`}
                class={`px-4 py-2 rounded-lg border ${
                  pageNum === page
                    ? "bg-blue-500 text-white border-blue-500"
                    : "bg-white text-gray-700 hover:bg-gray-100"
                }`}
              >
                {pageNum}
              </a>
            );
          })}
        </div>
      )}
    </div>
  </section>
</Layout>
