---
import Layout from "@/layouts/Layout.astro";
import { supabase } from "@/lib/supabase";


const { data, error } = await supabase.auth.getUser();
if (error || !data.user?.id) {
  return Astro.redirect("/");
}

const user = {
  name: data.user?.user_metadata.full_name,
  email: data.user?.email,
  id: data.user?.id,
};


const PAGE_SIZE = 6;
const page = Number(Astro.url.searchParams.get("page") || 1);
const from = (page - 1) * PAGE_SIZE;
const to = from + PAGE_SIZE - 1;

const { data: blogData, error: blogError, count } = await supabase
  .from("draft")
  .select("*", { count: "exact" })
  .eq("author", user.id)
  .order("created_at", { ascending: false })
  .range(from, to);

const totalPages = count ? Math.ceil(count / PAGE_SIZE) : 1;
---

<Layout title="Dashboard" desc="Welcome to your dashboard">
  <section class="max-w-screen-lg mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Welcome back, {user.name} üëã</h1>
        <p class="text-gray-600">Manage your posts and account settings here.</p>
      </div>
      <form action="api/auth/signout" method="get">
        <button class="bg-red-500 hover:bg-red-600 text-white font-medium px-5 py-2 rounded-xl shadow">
          Logout
        </button>
      </form>
    </div>


    <div class="mt-12 text-center">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Quick Actions</h2>
      <a
        href="/editor"
        class="bg-blue-500 hover:bg-blue-600 text-white font-medium px-8 py-4 rounded-2xl text-lg shadow transition"
      >
        ‚úçÔ∏è Write New Post
      </a>
    </div>
    <div class="mt-16">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Your Published Posts</h2>

      {blogData && blogData.length > 0 ? (
        <div class="gap-2 grid-cols-1 grid  md:grid-cols-2">
          {blogData.map((blog) => (
            <div class="bg-bg-secondary p-5 rounded-xl shadow hover:shadow-md transition">
              {
                blog.thumb ? (   
              <img src={blog.thumb} alt="thumbnail" class="aspect-video rounded-2xl object-cover"/>
                ) : (
                  <div></div>
                )
              }
              <h3 class="text-lg font-semibold text-text-primary">{blog.title || "Untitled Draft"}</h3>
              <p class="text-te text-text-secondary mt-1">{blog.desc || "No description"}</p>
              <div class="flex justify-between items-center mt-3">
                <span class="text-xs text-gray-400">
                  {new Date(blog.created_at).toLocaleDateString()}
                </span>
                <a
                  href={`/manage?id=${blog.id}`}
                  class="text-blue-500 hover:underline text-sm"
                >
                  Manage ‚Üí
                </a>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <p class="text-gray-500">You don‚Äôt have any Post published.</p>
      )}

      <!-- Pagination -->
      {totalPages > 1 && (
        <div class="flex justify-center gap-3 mt-8">
          {Array.from({ length: totalPages }).map((_, i) => {
            const pageNum = i + 1;
            return (
              <a
                href={`?page=${pageNum}`}
                class={`px-4 py-2 rounded-lg border ${
                  pageNum === page
                    ? "bg-blue-500 text-white border-blue-500"
                    : "bg-white text-gray-700 hover:bg-gray-100"
                }`}
              >
                {pageNum}
              </a>
            );
          })}
        </div>
      )}
    </div>
  </section>
</Layout>
