---
import FloatingInput from "@/components/FloatingInput.astro";

import ThumbnailUploader from "@/components/ThumbnailUploader";
import Layout from "@/layouts/Layout.astro";
import { supabase } from "@/lib/supabase";

const id = Astro.url.searchParams.get("id");
const user = await supabase.auth.getUser();
const userId = user.data.user?.id;
const admin = import.meta.env.EMAIL;
const email = user.data.user?.email;

if (!userId) {
  return Astro.redirect("/");
}

if (!id) {
  return Astro.redirect("/");
}

const { data, error } = await supabase.from("draft").select("*").eq("id", id);
if (!data || data.length === 0) {
  return Astro.redirect("/editor");
}

if (userId !== data[0].author) {
  return Astro.redirect("/");
}
---

<Layout
  title={data[0].title || "Untitled"}
  desc={data[0].desc || "No description"}
>
  <div class="max-w-screen-md mx-auto overflow-hidden overflow-x-hidden p-2">
    <h1 class="text-2xl md:text-4xl font-bold">Manage Page</h1>
    <p class="text-sm text-text-secondary">
      From here you can manage and update your draft.
    </p>
    <ThumbnailUploader client:only initialUrl={data[0].thumb} />

    <div class="flex flex-col gap-4 mt-4">
      <div>
        <FloatingInput value={data[0].title} label="Title" id="title" />
      </div>
      <p class="text-accent-primary text-sm p-2">Description</p>
      <div contenteditable="true" class="w-full min-h-12 outline-none border-b border-text-muted p-2">
        {data[0].desc}
      </div>
          <p class="text-accent-primary text-sm p-2">Tags</p>
      <div contenteditable="true" class="w-full min-h-12 outline-none border-b border-text-muted p-2">
        {data[0].tags}
      </div>
          <p class="text-accent-primary text-sm p-2">Keywords</p>
      <div contenteditable="true" class="w-full min-h-12 outline-none border-b border-text-muted p-2">
        {data[0].keywords}
      </div>
    <p class="text-accent-primary text-sm p-2">Category</p>
      <div contenteditable="true" class="w-full min-h-12 outline-none border-b border-text-muted p-2">
        {data[0].category}
      </div>
    </div>
  </div>
</Layout>
<script>
    const title = document.getElementById('title') as HTMLInputElement;
    const desc = document.getElementById('desc') as HTMLTextAreaElement;
    
</script>
